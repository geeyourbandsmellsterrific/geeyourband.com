---
import { marked } from "marked";
import { getCollection, getEntries } from "astro:content";
import BaseLayout from "src/layouts/BaseLayout.astro";
import CardMemberSmall from "@components/CardMemberSmall.astro";
import { Image } from "astro:assets";
import { formatDate } from "@js/utils";

export async function getStaticPaths() {
  const shows = await getCollection("show");
  return shows.map((show) => ({
    params: { show: show.slug },
    props: { show: show },
  }));
}

const { show } = Astro.props;
const content = await marked.parse(
  show.body.replace(/\n(?=\n)/g, "\n\n<br/>\n"),
);

const members = (await getEntries(show.data.member)).filter(
  (member) => member.collection === "member",
);
---

<BaseLayout
  title={show.data.title}
  description={show.body
    .split(" ")
    .slice(0, 20)
    .join(" ")
    .replace(/[#*_\`]/g, "")
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1")
    .trim() + (show.body.split(" ").length > 20 && "...")}
>
  <article
    id="show"
    class="mx-auto px-3 pt-16 max-[460px]:pt-10 pb-32 max-w-4xl"
  >
    {
      show.data.image && (
        <picture>
          <Image
            src={show.data.image}
            alt={show.data.imageAlt ? show.data.imageAlt : show.data.title}
            width={show.data.image.width}
            height={show.data.image.height}
            decoding="async"
            class="rounded-lg w-full h-auto"
          />
        </picture>
      )
    }

    <section id="show-details" class="flex flex-col gap-4 mt-8">
      <h1 id={show.data.title}>{show.data.title}</h1>
      <div>
        {show.data.date && <p>{formatDate(show.data.date)}</p>}

        <div class="flex flex-wrap justify-left items-start gap-4 mt-2">
          {
            members.map((member, index) => (
              <CardMemberSmall index={index} member={member} />
            ))
          }
        </div>
      </div>
    </section>

    <section id="show-content" class="my-8 overflow-auto">
      <p set:html={content} />
    </section>
  </article>
</BaseLayout>
